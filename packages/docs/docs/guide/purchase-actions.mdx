# Providing or Revoking Access

CheckoutEngine provides a convenient way to provide access after purchase. This is done through the
`Purchase` model and actions. The purchase model is a summary of all products that a customer current should have "access" to.
This way you do not need to check subscriptions, refunds, orders or any other information to determine if a customer has access to a
product.

## Store a `product_id` in your own plugin to reference your purchasable item.

This way, when you listen to events, you can sort out if you want to provide or revoke access to something based on the `product_id`.

## Providing Access

In this example, we are going to be providing access to a product when the purchase is *both* `created` AND `invoked`. This
handles the case where a customer purchases a product, and also when a purchase is revoked, but later invoked.

:::info Note
We provide two actions here on purpose. In some cases you may want to perform separate actions for `created` vs `invoked`.
An `invoked` event can only occur after a purchase was `revoked`. For example, you may want to send an email to the
customer when they purchase something, but not when their access is `revoked`, then `invoked` again.
:::

In this case we will run the same function for both events:

```php
<?php

// mapping a product id to our membership id.
$memberships = [
	'8ba8d60f-5277-4e6b-807c-dee8166446d5' => 'gold_membership'
];

// this action runs when a user checks out.
add_action( 'surecart/purchase_created', 'provide_access_to_membership', 10, 1 );
// this action runs when a revoked purchase is invoked ("un-revoked").
add_action( 'surecart/purchase_invoked', 'provide_access_to_membership', 10, 1 );

function provide_access_to_membership( \CheckoutEngine\Models\Purchase $purchase ) {
	// we only want to proceed if the purchase is for one of our products
	if ( empty( $memberships[ $purchase->product_id ] ) ) {
		return;
	}

	// get the purchase's WordPress user
	$wp_user = $purchase->getUser();

	// this order has no associated user.
	if ( $wp_user ) {
		// update user meta to provide access to something.
		update_user_meta( $wp_user->ID, $memberships[ $purchase->product_id ], true );
	}
}
```

## Revoking Access

We'll want to revoke access for the user when the purchase is revoked. This can happen if an order is refunded and the merchant
chooses to revoke access, or a subscription is canceled or expired. In this case we want to listen to the `purchase_revoked` event.

```php
<?php

// mapping a product id to our membership id.
$memberships = [
	'8ba8d60f-5277-4e6b-807c-dee8166446d5' => 'gold_membership'
];

// this action runs when a user's purchase is revoked. This can occur on refunds or subscription cancelations.
add_action( 'surecart/purchase_revoked', 'remove_access_to_membership', 10, 1 );

// Use the order_paid event to update the users meta
function remove_access_to_membership( \CheckoutEngine\Models\Purchase $purchase ) {
	// we only want to proceed if the purchase is for one of our products
	if ( empty( $memberships[ $purchase->product_id ] ) ) {
		return;
	}

	// get the purchase's WordPress user
	$wp_user = $purchase->getUser();

	// this order has no associated user.
	if ( $wp_user ) {
		// delete user meta access.
		delete_user_meta( $wp_user->ID, $memberships[ $purchase->product_id ] );
	}
}
```

## Updating Access

We'll want to update access for the user when the purchase is update. This can only happen if a purchase's `product` or `quantity`
changes. These actions can be done by the merchant, for example, by updating a customers subscription.


```php
<?php

// mapping product ids to our membership ids.
$memberships = [
	'8ba8d60f-5277-4e6b-807c-dee8166446d5' => 'Gold Membership',
	'8ba8d60f-5277-4e6b-807c-dee8166446d6' => 'Silver Membership',
];

// this action runs when a user's purchase is revoked. This can occur on refunds or subscription cancelations.
add_action( 'surecart/purchase_updated', 'update_access_to_membership', 10, 1 );

// Use the order_paid event to update the users meta
function update_access_to_membership( \CheckoutEngine\Models\Purchase $purchase ) {
	// we only want to proceed if the purchase is for one of our products
	if ( !in_array( $purchase->product_id, array_keys( $memberships ) ) ) {
		return;
	}

	// we are only concerned if the product changes.
	if ( $purchase->product_id === $purchase->previous_product_id ) {
		return;
	}

	// get the purchase's WordPress user
	$wp_user = $purchase->getUser();

	// update user meta for access.
	if ( $wp_user ) {
		// remove access to old.
		delete_user_meta( $wp_user->ID, $memberships[ $purchase->previous_product_id ] );
		// update access to new.
		update_user_meta( $wp_user->ID, $memberships[ $purchase->product_id ], true );
	}
}
```
